import { components } from "./_generated/api";
import { Autumn } from "@useautumn/convex";
{{#if (eq auth "better-auth")}}
import { authComponent } from "./auth";
import type { GenericCtx } from "@convex-dev/better-auth";
import type { DataModel } from "./_generated/dataModel";
{{/if}}
{{#if (eq auth "clerk")}}
import { getUserId } from "./auth";
{{/if}}

export const autumn = new Autumn(components.autumn, {
	secretKey: process.env.AUTUMN_SECRET_KEY!,
	identify: async (ctx{{#if (eq auth "better-auth")}}: GenericCtx<DataModel>{{/if}}) => {
{{#if (eq auth "better-auth")}}
		const user = await authComponent.getAuthUser(ctx);
		if (!user) return null;

		return {
			customerId: user.userId!,
			customerData: {
				name: user.name || "",
				email: user.email || "",
			},
		};
{{else if (eq auth "clerk")}}
		const userId = await getUserId(ctx);
		if (!userId) return null;

		return {
			customerId: userId,
			customerData: {
				name: "",
				email: "",
			},
		};
{{else}}
		// No auth configured - return default customer
		return {
			customerId: "better-t-stack",
			customerData: {
				name: "Better T Stack",
				email: "better-t-stack@example.com",
			},
		};
{{/if}}
	},
});

export const {
	track,
	cancel,
	query,
	attach,
	check,
	checkout,
	usage,
	setupPayment,
	createCustomer,
	listProducts,
	billingPortal,
	createReferralCode,
	redeemReferralCode,
	createEntity,
	getEntity,
} = autumn.api();

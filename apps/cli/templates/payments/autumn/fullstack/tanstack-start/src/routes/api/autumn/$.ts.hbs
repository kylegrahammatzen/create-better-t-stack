import { autumnHandler } from "autumn-js/backend";
import { createFileRoute } from "@tanstack/react-router";
{{#if (eq auth "better-auth")}}
import { auth } from "@{{projectName}}/auth";
{{/if}}

const handler = async (request: Request) => {
{{#if (eq auth "better-auth")}}
	const session = await auth.api.getSession({
		headers: request.headers,
	});

	if (!session) {
		return new Response(JSON.stringify({ error: "Unauthorized" }), {
			status: 401,
			headers: { "Content-Type": "application/json" },
		});
	}

	const customerId = session.user.id;
	const customerData = {
		name: session.user.name || "",
		email: session.user.email || "",
	};
{{else}}
	// No auth configured - use default customer
	const customerId = "better-t-stack";
	const customerData = { name: "Better T Stack", email: "better-t-stack@example.com" };
{{/if}}

	let body = null;
	if (request.method !== "GET") {
		body = await request.json();
	}

	const { statusCode, response } = await autumnHandler({
		customerId,
		customerData,
		request: {
			url: request.url,
			method: request.method,
			body: body,
		},
	});

	return new Response(JSON.stringify(response), {
		status: statusCode,
		headers: { "Content-Type": "application/json" },
	});
};

export const Route = createFileRoute("/api/autumn/$")({
	server: {
		handlers: {
			GET: ({ request }) => handler(request),
			POST: ({ request }) => handler(request),
		},
	},
});

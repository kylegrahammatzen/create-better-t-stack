import Header from "@/components/header";
import { ThemeProvider } from "@/components/theme-provider";
import { Toaster } from "@/components/ui/sonner";
{{#if (eq payments "autumn")}}
import { AutumnProvider } from "autumn-js/react";
{{#if (eq backend "convex")}}
{{#if (eq auth "clerk")}}
import { Authenticated } from "convex/react";
{{else if (eq auth "better-auth")}}
import { Authenticated } from "@convex-dev/better-auth/react";
{{/if}}
{{else}}
{{#if (eq auth "clerk")}}
import { SignedIn, SignedOut } from "@tanstack/react-router-clerk";
{{else if (eq auth "better-auth")}}
import { authClient } from "@/lib/auth-client";
{{/if}}
{{/if}}
{{/if}}
{{#if (eq api "orpc")}}
import { link, orpc } from "@/utils/orpc";
import type { QueryClient } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { useState } from "react";
import { createTanstackQueryUtils } from "@orpc/tanstack-query";
import type { AppRouterClient } from "@{{projectName}}/api/routers/index";
import { createORPCClient } from "@orpc/client";
{{/if}}
{{#if (eq api "trpc")}}
import type { trpc } from "@/utils/trpc";
import type { QueryClient } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
{{/if}}
import {
  HeadContent,
  Outlet,
  createRootRouteWithContext,
} from "@tanstack/react-router";
import { TanStackRouterDevtools } from "@tanstack/react-router-devtools";
import "../index.css";

{{#if (eq api "orpc")}}
export interface RouterAppContext {
  orpc: typeof orpc;
  queryClient: QueryClient;
}
{{else if (eq api "trpc")}}
export interface RouterAppContext {
  trpc: typeof trpc;
  queryClient: QueryClient;
}
{{else}}
export interface RouterAppContext {}
{{/if}}

export const Route = createRootRouteWithContext<RouterAppContext>()({
  component: RootComponent,
  head: () => ({
    meta: [
      {
        title: "{{projectName}}",
      },
      {
        name: "description",
        content: "{{projectName}} is a web application",
      },
    ],
    links: [
      {
        rel: "icon",
        href: "/favicon.ico",
      },
    ],
  }),
});

{{#unless (eq backend "convex")}}
{{#if (eq payments "autumn")}}
{{#if (eq auth "clerk")}}
function AutumnWrapper({ children }: { children: React.ReactNode }) {
  return (
    <>
      <SignedIn>
        <AutumnProvider{{#unless (eq backend "self")}} backendUrl={import.meta.env.VITE_SERVER_URL}{{/unless}}>
          {children}
        </AutumnProvider>
      </SignedIn>
      <SignedOut>
        {children}
      </SignedOut>
    </>
  );
}
{{else if (eq auth "better-auth")}}
function AutumnWrapper({ children }: { children: React.ReactNode }) {
  const session = authClient.useSession();

  if (!session.data) {
    return children;
  }

  return (
    <AutumnProvider{{#unless (eq backend "self")}} backendUrl={import.meta.env.VITE_SERVER_URL}{{/unless}}>
      {children}
    </AutumnProvider>
  );
}
{{/if}}
{{/if}}
{{/unless}}

function RootComponent() {
  {{#if (eq api "orpc")}}
  const [client] = useState<AppRouterClient>(() => createORPCClient(link));
  const [orpcUtils] = useState(() => createTanstackQueryUtils(client));
  {{/if}}

  return (
    {{#if (and (eq payments "autumn") (not (eq backend "convex")))}}<AutumnWrapper>{{/if}}
    <>
      <HeadContent />
      {{#if (and (eq payments "autumn") (eq backend "convex") (or (eq auth "clerk") (eq auth "better-auth")))}}<Authenticated>{{/if}}
      {{#if (eq api "orpc")}}
        <ThemeProvider
          attribute="class"
          defaultTheme="dark"
          disableTransitionOnChange
          storageKey="vite-ui-theme"
        >
          <div className="grid grid-rows-[auto_1fr] h-svh">
            <Header />
            <Outlet />
          </div>
          <Toaster richColors />
        </ThemeProvider>
      {{else}}
      <ThemeProvider
        attribute="class"
        defaultTheme="dark"
        disableTransitionOnChange
        storageKey="vite-ui-theme"
      >
        <div className="grid grid-rows-[auto_1fr] h-svh">
          <Header />
          <Outlet />
        </div>
        <Toaster richColors />
      </ThemeProvider>
      {{/if}}
      {{#if (and (eq payments "autumn") (eq backend "convex") (or (eq auth "clerk") (eq auth "better-auth")))}}</Authenticated>{{/if}}
      <TanStackRouterDevtools position="bottom-left" />
      {{#if (or (eq api "orpc") (eq api "trpc"))}}
      <ReactQueryDevtools position="bottom" buttonPosition="bottom-right" />
      {{/if}}
    </>
    {{#if (and (eq payments "autumn") (not (eq backend "convex")))}}</AutumnWrapper>{{/if}}
  );
}

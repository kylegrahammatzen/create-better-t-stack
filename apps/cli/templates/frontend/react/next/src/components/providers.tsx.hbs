"use client";

{{#if (eq backend "convex")}}
{{#if (eq auth "clerk")}}
import { useAuth } from "@clerk/nextjs";
import { ConvexReactClient } from "convex/react";
import { ConvexProviderWithClerk } from "convex/react-clerk";
{{#if (eq payments "autumn")}}
import { Authenticated } from "convex/react";
{{/if}}
{{else if (eq auth "better-auth")}}
import { ConvexProvider, ConvexReactClient, useConvex } from "convex/react";
import { ConvexBetterAuthProvider } from "@convex-dev/better-auth/react";
import { authClient } from "@/lib/auth-client";
{{#if (eq payments "autumn")}}
import { Authenticated } from "@convex-dev/better-auth/react";
{{/if}}
{{else}}
import { ConvexProvider, ConvexReactClient, useConvex } from "convex/react";
{{/if}}
{{#if (eq payments "autumn")}}
import { api } from "../../../../packages/backend/convex/_generated/api";
{{/if}}
{{else}}
{{#if (eq payments "autumn")}}
{{#if (eq auth "clerk")}}
import { SignedIn, SignedOut } from "@clerk/nextjs";
{{else if (eq auth "better-auth")}}
import { authClient } from "@/lib/auth-client";
{{/if}}
{{/if}}
{{#unless (eq api "none")}}
import { QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
{{#if (eq api "orpc")}}
import { queryClient } from "@/utils/orpc";
{{/if}}
{{#if (eq api "trpc")}}
import { queryClient } from "@/utils/trpc";
{{/if}}
{{/unless}}
{{/if}}
{{#if (eq payments "autumn")}}
import { AutumnProvider } from "autumn-js/react";
{{/if}}
import { ThemeProvider } from "./theme-provider";
import { Toaster } from "./ui/sonner";

{{#if (eq backend "convex")}}
const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);
{{#if (eq payments "autumn")}}

function AutumnWrapper({ children }: { children: React.ReactNode }) {
  const convex = useConvex();
  return (
    {{#if (or (eq auth "better-auth") (eq auth "clerk"))}}<Authenticated>{{/if}}
    <AutumnProvider convex={convex} convexApi={(api as any).autumn}>
      {children}
    </AutumnProvider>
    {{#if (or (eq auth "better-auth") (eq auth "clerk"))}}</Authenticated>{{/if}}
  );
}
{{/if}}
{{else}}
{{#if (eq payments "autumn")}}
{{#if (eq auth "clerk")}}

function AutumnWrapper({ children }: { children: React.ReactNode }) {
  return (
    <>
      <SignedIn>
        <AutumnProvider{{#unless (eq backend "self")}} backendUrl={process.env.NEXT_PUBLIC_SERVER_URL}{{/unless}}>
          {children}
        </AutumnProvider>
      </SignedIn>
      <SignedOut>
        {children}
      </SignedOut>
    </>
  );
}
{{else if (eq auth "better-auth")}}

function AutumnWrapper({ children }: { children: React.ReactNode }) {
  const session = authClient.useSession();

  if (!session.data) {
    return children;
  }

  return (
    <AutumnProvider{{#unless (eq backend "self")}} backendUrl={process.env.NEXT_PUBLIC_SERVER_URL}{{/unless}}>
      {children}
    </AutumnProvider>
  );
}
{{/if}}
{{/if}}
{{/if}}

export default function Providers({
  children
}: {
  children: React.ReactNode
}) {
  return (
    <ThemeProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange
    >
      {{#if (eq backend "convex")}}
      {{#if (eq auth "clerk")}}
      <ConvexProviderWithClerk client={convex} useAuth={useAuth}>
        {{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}
      </ConvexProviderWithClerk>
      {{else if (eq auth "better-auth")}}
      <ConvexBetterAuthProvider client={convex} authClient={authClient}>
        {{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}
      </ConvexBetterAuthProvider>
      {{else}}
      <ConvexProvider client={convex}>{{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}</ConvexProvider>
      {{/if}}
      {{else}}
      {{#unless (eq api "none")}}
      <QueryClientProvider client={queryClient}>
        {{#if (eq api "orpc")}}
        {{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}
        {{/if}}
        {{#if (eq api "trpc")}}
        {{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}
        {{/if}}
        <ReactQueryDevtools />
      </QueryClientProvider>
      {{else}}
      {{#if (eq payments "autumn")}}<AutumnWrapper>{children}</AutumnWrapper>{{else}}{children}{{/if}}
      {{/unless}}
      {{/if}}
      <Toaster richColors />
    </ThemeProvider>
  );
}
